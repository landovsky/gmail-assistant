#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
NAMESPACE="default"

# --- gmail-assistant-secrets (API keys) ---

: "${GEMINI_API_KEY:?Set GEMINI_API_KEY in your environment}"
: "${GMA_SERVER_ADMIN_USER:?Set GMA_SERVER_ADMIN_USER in your environment}"
: "${GMA_SERVER_ADMIN_PASSWORD:?Set GMA_SERVER_ADMIN_PASSWORD in your environment}"

echo "Updating gmail-assistant-secrets..."
kubectl delete secret gmail-assistant-secrets -n "$NAMESPACE" --ignore-not-found
kubectl create secret generic gmail-assistant-secrets \
  --from-literal=GEMINI_API_KEY="$GEMINI_API_KEY" \
  --from-literal=ADMIN_USER="$GMA_SERVER_ADMIN_USER" \
  --from-literal=ADMIN_PASSWORD="$GMA_SERVER_ADMIN_PASSWORD" \
  ${ANTHROPIC_API_KEY:+--from-literal=ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY"} \
  -n "$NAMESPACE"

# --- gmail-assistant-config (OAuth files) ---

CREDENTIALS="$PROJECT_DIR/config/credentials.json"
TOKEN="$PROJECT_DIR/config/token.json"

for f in "$CREDENTIALS" "$TOKEN"; do
  [ -f "$f" ] || { echo "Missing: $f"; exit 1; }
done

echo "Updating gmail-assistant-config..."
kubectl delete secret gmail-assistant-config -n "$NAMESPACE" --ignore-not-found
kubectl create secret generic gmail-assistant-config \
  --from-file=credentials.json="$CREDENTIALS" \
  --from-file=token.json="$TOKEN" \
  -n "$NAMESPACE"

echo "Done. Restart the pod to pick up changes:"
echo "  kubectl rollout restart deployment/gmail-assistant-deployment -n $NAMESPACE"

#!/bin/bash
# Phase A, Step 3: Waiting Re-triage
#
# Detects new messages in "Waiting" threads and removes the Waiting label.
# This is a standalone script version. For full integration, use:
#   claude -p /cleanup
#
# Usage:
#   ./bin/phase-a-step-3              # Run the step
#   ./bin/phase-a-step-3 --check-only # Check without making changes

set -uo pipefail

cd "$(dirname "$0")/.."

# Configuration
DB_PATH="data/inbox.db"
CONFIG_LABEL_FILE="config/label_ids.yml"
WAITING_LABEL_ID="Label_40"
DRY_RUN="${1:-}"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Counters
RETRIAGED_COUNT=0
PROCESSED_THREADS=""

# Helper functions
log_info() { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# SQL execution helper
sql_query() {
    sqlite3 "$DB_PATH" "$@" 2>/dev/null || echo ""
}

sql_exec() {
    sqlite3 "$DB_PATH" "$@" 2>/dev/null || return 1
}

# Function to search Gmail and count messages
# Note: This is where MCP tools would be called in the full implementation
search_gmail_count() {
    local subject="$1"
    # In the full implementation with MCP tools, this would be:
    # search_emails(q="subject:\"$subject\"") and count results
    # For now, we return empty to indicate it needs tool access
    echo ""
}

# Main execution
main() {
    echo "========================================================================"
    echo "Phase A, Step 3: Waiting Re-triage"
    echo "========================================================================"
    echo ""

    # Verify database exists
    if [ ! -f "$DB_PATH" ]; then
        log_error "Database not found: $DB_PATH"
        return 1
    fi

    # Get waiting threads from database
    log_info "Querying database for waiting threads..."
    waiting_query=$(cat << 'SQL'
SELECT gmail_thread_id, subject, message_count, gmail_message_id
FROM emails
WHERE classification='waiting'
ORDER BY processed_at DESC;
SQL
)

    waiting_threads=$(sql_query "$waiting_query")

    if [ -z "$waiting_threads" ]; then
        log_info "No waiting threads found."
        echo ""
        echo "========================================================================"
        echo "{"
        echo '  "archived": 0,'
        echo '  "sent_detected": 0,'
        echo '  "retriaged": 0'
        echo "}"
        echo "========================================================================"
        return 0
    fi

    thread_count=$(echo "$waiting_threads" | wc -l)
    log_info "Found $thread_count waiting thread(s)"
    echo ""

    # Process each thread
    while IFS='|' read -r thread_id subject stored_count msg_id; do
        # Skip empty lines
        [ -z "$thread_id" ] && continue

        # Check if already processed in this run
        if echo "$PROCESSED_THREADS" | grep -q "$thread_id"; then
            log_warn "Thread $thread_id already processed, skipping"
            continue
        fi

        PROCESSED_THREADS="$PROCESSED_THREADS $thread_id"

        echo "Processing: $thread_id"
        echo "  Subject: $subject"
        echo "  Stored message count: $stored_count"
        echo "  Message ID: $msg_id"

        # Search Gmail for current message count
        # This requires MCP tools which are available in the full Claude execution environment
        current_count=$(search_gmail_count "$subject")

        if [ -z "$current_count" ]; then
            log_warn "Cannot access Gmail (MCP tools not available in this context)"
            log_info "To run with full functionality: bin/process-inbox all"
            echo ""
            continue
        fi

        echo "  Current message count: $current_count"

        # Check if new message arrived
        if [ "$current_count" -gt "$stored_count" ]; then
            echo "  ✓ NEW MESSAGE DETECTED ($stored_count → $current_count)"

            if [ "$DRY_RUN" = "--check-only" ]; then
                echo "  [DRY RUN - would remove Waiting label]"
            else
                # Remove Waiting label via MCP tool
                # modify_email(id=msg_id, removeLabelIds=[WAITING_LABEL_ID])
                # This requires MCP tools availability
                log_warn "Label removal requires MCP tools (would call modify_email)"

                # Update database
                update_query="UPDATE emails SET message_count = $current_count, updated_at = CURRENT_TIMESTAMP WHERE gmail_thread_id = '$thread_id'"
                if sql_exec "$update_query"; then
                    echo "  ✓ Updated message count in DB"
                else
                    log_error "Failed to update message count in DB"
                    continue
                fi

                # Log event
                event_query=$(cat << SQL
INSERT INTO email_events (gmail_thread_id, event_type, detail, created_at)
VALUES ('$thread_id', 'waiting_retriaged',
        'New reply detected, removed Waiting label (count: $stored_count → $current_count)',
        CURRENT_TIMESTAMP)
SQL
)
                if sql_exec "$event_query"; then
                    echo "  ✓ Logged event"
                else
                    log_error "Failed to log event"
                    continue
                fi

                RETRIAGED_COUNT=$((RETRIAGED_COUNT + 1))
            fi
        else
            echo "  No new messages"
        fi

        echo ""

    done <<< "$waiting_threads"

    # Output summary
    echo "========================================================================"
    echo "Summary:"
    cat << JSON
{
  "archived": 0,
  "sent_detected": 0,
  "retriaged": $RETRIAGED_COUNT
}
JSON
    echo "========================================================================"
}

main "$@"

#!/bin/bash
# bin/process-inbox
# Runs the full inbox processing pipeline.
#
# Usage:
#   bin/process-inbox           # Run full pipeline
#   bin/process-inbox triage    # Run only inbox-triage
#   bin/process-inbox draft     # Run only draft-response
#   bin/process-inbox invoices  # Run only process-invoices

set -uo pipefail
source "$(dirname "$0")/common.sh"

case "${1:-all}" in
    triage)   run_step "Inbox Triage" haiku inbox-triage "$GMAIL_READ $GMAIL_WRITE $LOCAL_TOOLS" ;;
    draft)    run_step "Draft Responses" sonnet draft-response "$GMAIL_READ $GMAIL_WRITE $GMAIL_DRAFT $LOCAL_TOOLS" ;;
    invoices) run_step "Process Invoices" haiku process-invoices "$GMAIL_READ $LOCAL_TOOLS" ;;
    all)
        run_step "Inbox Triage" haiku inbox-triage "$GMAIL_READ $GMAIL_WRITE $LOCAL_TOOLS"
        run_step "Draft Responses" sonnet draft-response "$GMAIL_READ $GMAIL_WRITE $GMAIL_DRAFT $LOCAL_TOOLS"
        run_step "Process Invoices" haiku process-invoices "$GMAIL_READ $LOCAL_TOOLS"
        echo ""
        echo "=== [$( timestamp )] Pipeline complete ==="
        ;;
    *)
        echo "Usage: $0 [triage|draft|invoices|all]"
        exit 1
        ;;
esac

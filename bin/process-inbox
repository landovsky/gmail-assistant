#!/bin/bash
# bin/process-inbox
# Runs the full inbox processing pipeline.
#
# Usage:
#   bin/process-inbox           # Run full pipeline
#   bin/process-inbox triage    # Run only inbox-triage
#   bin/process-inbox draft     # Run only draft-response

set -uo pipefail
source "$(dirname "$0")/common.sh"

SCRIPT_START=$(date +%s)
log_info "=== process-inbox: started (mode=${1:-all}) ==="

case "${1:-all}" in
    triage)   run_step "Inbox Triage" haiku inbox-triage "$GMAIL_READ $GMAIL_WRITE $LOCAL_TOOLS" ;;
    draft)    run_step "Draft Responses" sonnet draft-response "$GMAIL_READ $GMAIL_WRITE $GMAIL_DRAFT $LOCAL_TOOLS" ;;
    all)
        run_step "Cleanup & Lifecycle" sonnet cleanup "$GMAIL_READ $GMAIL_WRITE $LOCAL_TOOLS"
        run_step "Inbox Triage" haiku inbox-triage "$GMAIL_READ $GMAIL_WRITE $LOCAL_TOOLS"
        run_step "Draft Responses" sonnet draft-response "$GMAIL_READ $GMAIL_WRITE $GMAIL_DRAFT $LOCAL_TOOLS"
        ;;
    *)
        echo "Usage: $0 [triage|draft|all]"
        exit 1
        ;;
esac

SCRIPT_END=$(date +%s)
log_info "=== process-inbox: finished ($(( SCRIPT_END - SCRIPT_START ))s total) ==="

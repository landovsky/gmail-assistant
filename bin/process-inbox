#!/bin/bash
# bin/process-inbox
# Runs the full inbox processing pipeline.
#
# Each step invokes a custom command via `claude -p "/command-name"`.
# --allowedTools whitelists only the tools each step needs â€” notably
# excluding send_email and delete_email to enforce the spec's safety
# guarantees.
#
# Usage:
#   bin/process-inbox           # Run full pipeline
#   bin/process-inbox triage    # Run only inbox-triage
#   bin/process-inbox draft     # Run only draft-response
#   bin/process-inbox rework    # Run only rework-draft
#   bin/process-inbox invoices  # Run only process-invoices
#   bin/process-inbox briefing  # Run only morning-briefing

set -uo pipefail

cd "$(dirname "$0")/.."

# Tools shared across all steps (never includes send_email or delete_email)
GMAIL_READ="mcp__gmail__search_emails mcp__gmail__read_email mcp__gmail__list_email_labels"
GMAIL_WRITE="mcp__gmail__modify_email mcp__gmail__batch_modify_emails"
GMAIL_DRAFT="mcp__gmail__draft_email"
LOCAL_TOOLS="Bash Read Glob Grep"

timestamp() { date "+%Y-%m-%d %H:%M:%S"; }

run_step() {
    local name="$1"
    local model="$2"
    local command="$3"
    local tools="$4"

    echo ""
    echo "=== [$( timestamp )] $name ==="

    claude --model "$model" \
        -p "/$command" \
        --allowedTools $tools \
        --max-budget-usd 1.00

    local exit_code=$?
    if [[ $exit_code -ne 0 ]]; then
        echo "WARNING: $name exited with code $exit_code"
    fi
    return $exit_code
}

# Define steps
run_triage() {
    run_step "Inbox Triage" haiku \
        inbox-triage \
        "$GMAIL_READ $GMAIL_WRITE $LOCAL_TOOLS"
}

run_draft() {
    run_step "Draft Responses" sonnet \
        draft-response \
        "$GMAIL_READ $GMAIL_WRITE $GMAIL_DRAFT $LOCAL_TOOLS"
}

run_rework() {
    run_step "Rework Drafts" sonnet \
        rework-draft \
        "$GMAIL_READ $GMAIL_WRITE $GMAIL_DRAFT $LOCAL_TOOLS"
}

run_invoices() {
    run_step "Process Invoices" haiku \
        process-invoices \
        "$GMAIL_READ $LOCAL_TOOLS"
}

# Run specific step or full pipeline
case "${1:-all}" in
    triage)   run_triage ;;
    draft)    run_draft ;;
    rework)   run_rework ;;
    invoices) run_invoices ;;
    all)
        run_triage
        run_draft
        run_rework
        run_invoices
        echo ""
        echo "=== [$( timestamp )] Pipeline complete ==="
        ;;
    *)
        echo "Usage: $0 [triage|draft|rework|invoices|all]"
        exit 1
        ;;
esac

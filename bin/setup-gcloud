#!/usr/bin/env bash
# Setup Google Cloud Pub/Sub for Gmail push notifications
# Usage: bin/setup-gcloud enable --url <webhook-url> --env <dev|production>

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
ENV="dev"
WEBHOOK_URL=""
PROJECT_ID=""
COMMAND=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    enable|disable|status)
      COMMAND="$1"
      shift
      ;;
    -u|--url)
      WEBHOOK_URL="$2"
      shift 2
      ;;
    -e|--env)
      ENV="$2"
      shift 2
      ;;
    -p|--project)
      PROJECT_ID="$2"
      shift 2
      ;;
    -h|--help)
      cat <<EOF
${BLUE}Gmail Assistant - Google Cloud Pub/Sub Setup${NC}

${GREEN}Usage:${NC}
  bin/setup-gcloud enable --url <webhook-url> [--env <env>] [--project <project-id>]
  bin/setup-gcloud disable [--env <env>] [--project <project-id>]
  bin/setup-gcloud status [--env <env>] [--project <project-id>]

${GREEN}Commands:${NC}
  enable    Create Pub/Sub topic and subscription, grant permissions
  disable   Delete topic and subscription
  status    Show current Pub/Sub configuration

${GREEN}Options:${NC}
  -u, --url <url>        Webhook URL (e.g., https://example.ngrok.app)
  -e, --env <env>        Environment: dev or production (default: dev)
  -p, --project <id>     Google Cloud project ID (auto-detected if not provided)
  -h, --help             Show this help message

${GREEN}Examples:${NC}
  # Enable with ngrok tunnel
  bin/setup-gcloud enable --url https://abc123.ngrok-free.app

  # Enable for production
  bin/setup-gcloud enable --url https://api.example.com --env production

  # Check status
  bin/setup-gcloud status

  # Disable dev environment
  bin/setup-gcloud disable --env dev

${YELLOW}Prerequisites:${NC}
  - gcloud CLI installed and authenticated (gcloud auth login)
  - Google Cloud project with Gmail API enabled
  - Pub/Sub API enabled (gcloud services enable pubsub.googleapis.com)

EOF
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      echo "Run 'bin/setup-gcloud --help' for usage information"
      exit 1
      ;;
  esac
done

# Validate command
if [[ -z "$COMMAND" ]]; then
  echo -e "${RED}Error: No command specified${NC}"
  echo "Run 'bin/setup-gcloud --help' for usage information"
  exit 1
fi

# Get or validate project ID
if [[ -z "$PROJECT_ID" ]]; then
  PROJECT_ID=$(gcloud config get-value project 2>/dev/null)
  if [[ -z "$PROJECT_ID" ]]; then
    echo -e "${RED}Error: No Google Cloud project configured${NC}"
    echo "Run: gcloud config set project YOUR_PROJECT_ID"
    exit 1
  fi
fi

# Topic and subscription names
TOPIC_NAME="gmail-notifications-${ENV}"
SUBSCRIPTION_NAME="gmail-push-${ENV}"
GMAIL_SERVICE_ACCOUNT="serviceAccount:gmail-api-push@system.gserviceaccount.com"

echo -e "${BLUE}Gmail Assistant - Pub/Sub Setup${NC}"
echo -e "${BLUE}================================${NC}"
echo -e "Project ID:   ${GREEN}${PROJECT_ID}${NC}"
echo -e "Environment:  ${GREEN}${ENV}${NC}"
echo -e "Topic:        ${GREEN}${TOPIC_NAME}${NC}"
echo -e "Subscription: ${GREEN}${SUBSCRIPTION_NAME}${NC}"
echo ""

# Function to check if topic exists
topic_exists() {
  gcloud pubsub topics describe "$TOPIC_NAME" --project="$PROJECT_ID" &>/dev/null
}

# Function to check if subscription exists
subscription_exists() {
  gcloud pubsub subscriptions describe "$SUBSCRIPTION_NAME" --project="$PROJECT_ID" &>/dev/null
}

# Enable command
if [[ "$COMMAND" == "enable" ]]; then
  if [[ -z "$WEBHOOK_URL" ]]; then
    echo -e "${RED}Error: --url is required for enable command${NC}"
    echo "Example: bin/setup-gcloud enable --url https://abc123.ngrok-free.app"
    exit 1
  fi

  # Normalize webhook URL (remove trailing slash, ensure https)
  WEBHOOK_URL="${WEBHOOK_URL%/}"
  WEBHOOK_ENDPOINT="${WEBHOOK_URL}/webhook/gmail"

  echo -e "${YELLOW}Webhook endpoint: ${WEBHOOK_ENDPOINT}${NC}"
  echo ""

  # Check if Pub/Sub API is enabled
  echo -e "${BLUE}[1/5] Checking Pub/Sub API...${NC}"
  if ! gcloud services list --enabled --project="$PROJECT_ID" | grep -q pubsub.googleapis.com; then
    echo -e "${YELLOW}Enabling Pub/Sub API...${NC}"
    gcloud services enable pubsub.googleapis.com --project="$PROJECT_ID"
    echo -e "${GREEN}✓ Pub/Sub API enabled${NC}"
  else
    echo -e "${GREEN}✓ Pub/Sub API already enabled${NC}"
  fi
  echo ""

  # Create topic
  echo -e "${BLUE}[2/5] Creating Pub/Sub topic...${NC}"
  if topic_exists; then
    echo -e "${YELLOW}Topic already exists: ${TOPIC_NAME}${NC}"
  else
    gcloud pubsub topics create "$TOPIC_NAME" --project="$PROJECT_ID"
    echo -e "${GREEN}✓ Created topic: ${TOPIC_NAME}${NC}"
  fi
  echo ""

  # Grant Gmail permission to publish
  echo -e "${BLUE}[3/5] Granting Gmail publish permissions...${NC}"
  gcloud pubsub topics add-iam-policy-binding "$TOPIC_NAME" \
    --member="$GMAIL_SERVICE_ACCOUNT" \
    --role="roles/pubsub.publisher" \
    --project="$PROJECT_ID" \
    --quiet
  echo -e "${GREEN}✓ Granted Gmail publish permissions${NC}"
  echo ""

  # Create push subscription
  echo -e "${BLUE}[4/5] Creating push subscription...${NC}"
  if subscription_exists; then
    echo -e "${YELLOW}Deleting existing subscription to recreate with new URL...${NC}"
    gcloud pubsub subscriptions delete "$SUBSCRIPTION_NAME" --project="$PROJECT_ID" --quiet
  fi

  gcloud pubsub subscriptions create "$SUBSCRIPTION_NAME" \
    --topic="$TOPIC_NAME" \
    --push-endpoint="$WEBHOOK_ENDPOINT" \
    --ack-deadline=10 \
    --project="$PROJECT_ID"
  echo -e "${GREEN}✓ Created push subscription: ${SUBSCRIPTION_NAME}${NC}"
  echo ""

  # Output configuration
  echo -e "${BLUE}[5/5] Configuration complete!${NC}"
  echo ""
  TOPIC_PATH="projects/${PROJECT_ID}/topics/${TOPIC_NAME}"

  echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${GREEN}Next Steps:${NC}"
  echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  echo -e "${YELLOW}1. Add this to your .env file:${NC}"
  echo ""
  echo "   GMA_SYNC_PUBSUB_TOPIC=${TOPIC_PATH}"
  echo ""
  echo -e "${YELLOW}2. Restart your Rails server to pick up the config${NC}"
  echo ""
  echo -e "${YELLOW}3. Register the watch with Gmail:${NC}"
  echo ""
  echo "   curl -X POST http://localhost:3000/api/watch"
  echo ""
  echo -e "${YELLOW}4. Test the webhook (optional):${NC}"
  echo ""
  echo "   gcloud pubsub topics publish ${TOPIC_NAME} \\"
  echo "     --message='{\"emailAddress\":\"test@example.com\",\"historyId\":\"12345\"}' \\"
  echo "     --project=${PROJECT_ID}"
  echo ""
  echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

  # Optionally update .env file
  if [[ -f .env ]]; then
    echo ""
    read -p "$(echo -e ${YELLOW}Update .env file automatically? [y/N]: ${NC})" -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      # Remove old line if exists
      if grep -q "^GMA_SYNC_PUBSUB_TOPIC=" .env; then
        sed -i.bak "/^GMA_SYNC_PUBSUB_TOPIC=/d" .env
      fi
      echo "GMA_SYNC_PUBSUB_TOPIC=${TOPIC_PATH}" >> .env
      echo -e "${GREEN}✓ Updated .env file${NC}"
    fi
  fi

# Disable command
elif [[ "$COMMAND" == "disable" ]]; then
  echo -e "${YELLOW}This will delete the Pub/Sub topic and subscription.${NC}"
  read -p "$(echo -e ${YELLOW}Are you sure? [y/N]: ${NC})" -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${BLUE}Cancelled${NC}"
    exit 0
  fi

  # Delete subscription
  if subscription_exists; then
    echo -e "${BLUE}Deleting subscription...${NC}"
    gcloud pubsub subscriptions delete "$SUBSCRIPTION_NAME" --project="$PROJECT_ID" --quiet
    echo -e "${GREEN}✓ Deleted subscription: ${SUBSCRIPTION_NAME}${NC}"
  else
    echo -e "${YELLOW}Subscription does not exist: ${SUBSCRIPTION_NAME}${NC}"
  fi

  # Delete topic
  if topic_exists; then
    echo -e "${BLUE}Deleting topic...${NC}"
    gcloud pubsub topics delete "$TOPIC_NAME" --project="$PROJECT_ID" --quiet
    echo -e "${GREEN}✓ Deleted topic: ${TOPIC_NAME}${NC}"
  else
    echo -e "${YELLOW}Topic does not exist: ${TOPIC_NAME}${NC}"
  fi

  echo ""
  echo -e "${GREEN}Cleanup complete!${NC}"
  echo ""
  echo -e "${YELLOW}Don't forget to:${NC}"
  echo "1. Remove GMA_SYNC_PUBSUB_TOPIC from .env"
  echo "2. Restart your Rails server"

# Status command
elif [[ "$COMMAND" == "status" ]]; then
  echo -e "${BLUE}Checking Pub/Sub status...${NC}"
  echo ""

  # Check topic
  if topic_exists; then
    echo -e "${GREEN}✓ Topic exists: ${TOPIC_NAME}${NC}"

    # Check IAM bindings
    echo -e "${BLUE}  IAM bindings:${NC}"
    gcloud pubsub topics get-iam-policy "$TOPIC_NAME" --project="$PROJECT_ID" \
      | grep -A 2 "gmail-api-push@system.gserviceaccount.com" \
      || echo -e "${RED}    No Gmail permissions found${NC}"
  else
    echo -e "${RED}✗ Topic does not exist: ${TOPIC_NAME}${NC}"
  fi
  echo ""

  # Check subscription
  if subscription_exists; then
    echo -e "${GREEN}✓ Subscription exists: ${SUBSCRIPTION_NAME}${NC}"
    echo -e "${BLUE}  Details:${NC}"
    gcloud pubsub subscriptions describe "$SUBSCRIPTION_NAME" \
      --project="$PROJECT_ID" \
      --format="table[box](name,topic,pushConfig.pushEndpoint,ackDeadlineSeconds)"
  else
    echo -e "${RED}✗ Subscription does not exist: ${SUBSCRIPTION_NAME}${NC}"
  fi
  echo ""

  # Check .env configuration
  if [[ -f .env ]]; then
    TOPIC_PATH="projects/${PROJECT_ID}/topics/${TOPIC_NAME}"
    if grep -q "GMA_SYNC_PUBSUB_TOPIC=${TOPIC_PATH}" .env; then
      echo -e "${GREEN}✓ .env file configured correctly${NC}"
    else
      echo -e "${YELLOW}⚠ .env file missing or misconfigured${NC}"
      echo "  Expected: GMA_SYNC_PUBSUB_TOPIC=${TOPIC_PATH}"
    fi
  else
    echo -e "${YELLOW}⚠ .env file not found${NC}"
  fi
fi
